pipeline {
   agent any

   stages {
      steps('Verify Branch') {
         step {
            echo "$GIT_BRANCH"
         }
      }
      stage('Package') {
         step {
            echo "package"
            sh (script: """
                mvn -f app/pom.xml clean package
                pwd
            """)  
            }
      }
      stage('Policy') {
          step {
              withCredentials([usernamePassword(credentialsId: 'veracode-credentials', passwordVariable: '$veracode_key', usernameVariable: '$veracode_id')]) {
                  // fire-and-forget
                  veracode applicationName: 'Verademo', canFailJob: true, createSandbox: true, criticality: 'High', debug: true, fileNamePattern: '', replacementPattern: '', sandboxName: 'Jenkins Pipeline', scanExcludesPattern: '', scanIncludesPattern: '', scanName: "${BUILD_TAG}", teams: '', uploadExcludesPattern: '', uploadIncludesPattern: '**/**.war', vid: "${$veracode_id}", vkey: "${$veracode_key}"
              }
          }
      }
   }
      stage('Pipeline') {
         step {
            echo 'Veracode Pipeline scanning'
            withCredentials([ usernamePassword (credentialsId: 'veracode_login', usernameVariable: 'VERACODE_API_ID', passwordVariable: 'VERACODE_API_KEY') ]) {
                  script {
                     try {
                           sh """
                              curl https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip -o pipeline-scan.zip
                              unzip -u pipeline-scan.zip pipeline-scan.jar
                              java -jar pipeline-scan.jar --veracode_api_id '${VERACODE_API_ID}' --veracode_api_key '${VERACODE_API_KEY}' --file app/target/verademo.war --baseline results.json --issue_details true
                           """
                     } catch (err) {
                        echo 'The error code is ' + err.getMessage().substring(26)
                       }
                     }    
               } 
            echo "Pipeline scan done (failures ignored, results available in ${WORKSPACE}/results.json)"
         }
      }
   }
   post {
      always {
         archiveArtifacts artifacts: 'app/target/*.war, results.json', followSymlinks: false
      }
   }
